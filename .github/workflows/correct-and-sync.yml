name: ALN File Correction & Live Repo Sync

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  correct-and-sync:
    runs-on: ubuntu-latest

    steps:
      # --- Full-depth checkout with PAT for push/rebase ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: Doctor0Evil/ALN_Programming_Language
          token: ${{ secrets.ALN_PUSH_TOKEN }}   # PAT with 'repo' + 'workflow' scopes
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true

      # --- Ensure PowerShell 7 is available ---
      - name: Install PowerShell 7
        uses: PSModule/install-powershell@v1
        with:
          Version: 'latest'

      # --- Run all corrections via manifest-driven runner ---
      - name: Run manifest-driven ALN corrections
        shell: pwsh -NoProfile -ExecutionPolicy Bypass
        run: |
          $ErrorActionPreference = 'Stop'
          $scriptsDir = Join-Path $PWD 'scripts'
          $runnerScript = Join-Path $scriptsDir 'run-all-corrections.ps1'

          if (-not (Test-Path $runnerScript)) {
            throw "Correction runner not found at $runnerScript"
          }

          & $runnerScript

      # --- Commit and safe push with retry ---
      - name: Auto-commit & Safe Push with Retry
        shell: bash
        run: |
          set -e

          git config user.name "ALN-AutoFixer"
          git config user.email "autofix@aln.dev"

          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "ALN: Automated repository-wide correction via manifest runner"

          # Authenticated push with PAT
          git remote set-url origin https://x-access-token:${{ secrets.ALN_PUSH_TOKEN }}@github.com/Doctor0Evil/ALN_Programming_Language.git

          attempt_push() {
            git pull --rebase origin main || return 1
            git push origin main || return 1
          }

          for i in 1 2 3; do
            if attempt_push; then
              echo "Push successful."
              exit 0
            fi
            echo "Push failed (attempt $i). Retrying in $((i*5))s..."
            sleep $((i*5))
          done

          echo "Push failed after 3 attempts."
          exit 1

      # --- Upload audit logs as workflow artifact ---
      - name: Upload Correction Audit Logs
        uses: actions/upload-artifact@v4
        with:
          name: aln-correction-audit-logs
          path: |
            scripts/audit-session.log
            scripts/log-*.txt
          retention-days: 14
